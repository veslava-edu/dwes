
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://veslava-edu.github.io/dwes/3-NODE/11-Seguridad/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>11 Seguridad - DWES</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script><script src="../../toggle-sidebar.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#seguridad-autenticacion-autorizacion-jwt-y-ssl" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DWES" class="md-header__button md-logo" aria-label="DWES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DWES
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              11 Seguridad
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Cambiar a modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Inicio

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../1-ArquitecturaWEB/UD1-Arquitectura-Web-y-Software-en-Servidor/" class="md-tabs__link">
          
  
  
  Arquitectura WEB y Servidor

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../2-PHP/01-Introduccion/" class="md-tabs__link">
          
  
  
  PHP

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="#" class="md-tabs__link">
          
  
  
  Node.js

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DWES" class="md-nav__button md-logo" aria-label="DWES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DWES
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inicio
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Arquitectura WEB y Servidor
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Arquitectura WEB y Servidor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1-Arquitectura-Web-y-Software-en-Servidor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    00 - Arquitectura-Web-y-Software-en-Servidor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.1-Entorno-WAMP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Entorno-WAMP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.2-Virtualizacion-Docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Virtualizacion-Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.3-Control-Versiones-GIT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Control-Versiones-GIT
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PHP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            PHP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/01-Introduccion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Introducción
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/02-Sintaxis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Sintaxis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/03-Control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Estructuras de Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/04-Arrays-Funciones-Strings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 - Arrays, Funciones y Strings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/05-POO/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    05 - POO - Programación Orientada a Objetos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/06-Include/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    06 - Include y Require
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/07-GET-POST-Formularios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 - GET y POST - Formularios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/08-Gesti%C3%B3n-de-estado-Cookies-Sesiones/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    08 - Gestión de estado - Cookies y Sesiones
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/09-Ficheros/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    09 - Ficheros
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/10-BasesDatos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 - Bases de Datos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/11-Navegacion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11 - Navegación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/12-Dependencias/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12 - Dependencias
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/13-Servicios-WEB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13 - Servicios WEB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/14-Documentacion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14 - Documentación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/15-LOGS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    15 - Logs en PHP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/16-WebScraping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    16 - WebScraping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/17-Testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    17 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_18" >
        
          
          <label class="md-nav__link" for="__nav_3_18" id="__nav_3_18_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Laravel
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_18">
            <span class="md-nav__icon md-icon"></span>
            Laravel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L1 - Introducción a Laravel
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L2 - Entorno
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L3 - Eloquent ORM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 - Controladores
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L5 - Almacenamiento
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L6 - Vistas (Blade)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L7 - Autenticación y Autorización
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L8 - Sesiones y Cookies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L9 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Node.js
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Node.js
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Intro a Node.js
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Intro a TypeScript
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Intro a NestJS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 - Creación de Recursos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    05 - TypeORM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    06 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 - Almacenamiento de Ficheros
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    08 - WebSockets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    09 - Endpoints Avanzados
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 - MongoDB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11 - Seguridad
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12 - Documentación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13 - Perfiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14 - Despliegue
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instalacion-de-dependencias" class="md-nav__link">
    <span class="md-ellipsis">
      Instalación de dependencias
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurando-las-opciones-de-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      Configurando las opciones de JWT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementando-la-autenticacion-y-autorizacion" class="md-nav__link">
    <span class="md-ellipsis">
      Implementando la autenticación y autorización
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementando la autenticación y autorización">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modulo-de-autenticacion" class="md-nav__link">
    <span class="md-ellipsis">
      Módulo de autenticación
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estrategia-de-autenticacion-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      Estrategia de autenticación JWT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guardas-de-autorizacion-y-autenticacion" class="md-nav__link">
    <span class="md-ellipsis">
      Guardas de autorización y autenticación
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementando-el-servicio-de-autenticacion" class="md-nav__link">
    <span class="md-ellipsis">
      Implementando el servicio de autenticación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protegiendo-las-rutas" class="md-nav__link">
    <span class="md-ellipsis">
      Protegiendo las rutas
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<ul>
<li><a href="#seguridad-autenticación-autorización-jwt-y-ssl">Seguridad: Autenticación, Autorización, JWT y SSL</a></li>
<li><a href="#instalación-de-dependencias">Instalación de dependencias</a></li>
<li><a href="#configurando-las-opciones-de-jwt">Configurando las opciones de JWT</a></li>
<li><a href="#implementando-la-autenticación-y-autorización">Implementando la autenticación y autorización</a><ul>
<li><a href="#módulo-de-autenticación">Módulo de autenticación</a></li>
<li><a href="#estrategia-de-autenticación-jwt">Estrategia de autenticación JWT</a></li>
<li><a href="#guardas-de-autorización-y-autenticación">Guardas de autorización y autenticación</a></li>
<li><a href="#implementando-el-servicio-de-autenticación">Implementando el servicio de autenticación</a></li>
</ul>
</li>
<li><a href="#protegiendo-las-rutas">Protegiendo las rutas</a></li>
<li><a href="#ssl-y-https">SSL y HTTPS</a></li>
<li><a href="#testeando-la-seguridad">Testeando la seguridad</a></li>
<li><a href="#práctica-de-clase-seguridad">Práctica de clase: Seguridad</a></li>
<li><a href="#proyecto">Proyecto</a></li>
</ul>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../images/11-banner.webp"><img alt="" src="../images/11-banner.webp"/></a></p>
<h1 id="seguridad-autenticacion-autorizacion-jwt-y-ssl">Seguridad: Autenticación, Autorización, JWT y SSL</h1>
<p>En este apartado veremos los conceptos de seguridad más importantes en el desarrollo de APIs REST, como son la autenticación, autorización, JWT y SSL. </p>
<h2 id="instalacion-de-dependencias">Instalación de dependencias</h2>
<p>Lo primero que vamos a necesitar es instalar las dependencias necesarias para trabajar con con la autenticación JWT en Nestjs. </p>
<p>Podemos apostar por usar el módulo de autenticación de Nestjs, pero vamos a usar <a href="https://www.passportjs.org/">Passport</a>, que es un módulo de autenticación más genérico y que nos permite usar diferentes estrategias de autenticación, entre ellas JWT.</p>
<p>Para ello, vamos a instalar las siguientes dependencias:</p>
<ul>
<li><strong>@nestjs/jwt</strong>: Módulo de JWT para Nestjs.</li>
<li><strong>@nestjs/passport</strong>: Módulo de passport para Nestjs.</li>
<li><strong>passport</strong>: Módulo de passport.</li>
<li><strong>passport-jwt</strong>: Módulo de passport para JWT.</li>
<li><strong>bcryptjs</strong>: Módulo para encriptar contraseñas.</li>
<li><strong>@types/passport-jwt</strong>: Tipado de passport para JWT.</li>
<li><strong>@types/bcryptjs</strong>: Tipado de bcryptjs.</li>
</ul>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>--save<span class="w"> </span>@nestjs/jwt<span class="w"> </span>@nestjs/passport<span class="w"> </span>passport<span class="w"> </span>passport-jwt<span class="w"> </span>bcryptjs<span class="w"> </span>
npm<span class="w"> </span>install<span class="w"> </span>--save-dev<span class="w"> </span>@types/passport-jwt<span class="w"> </span>@types/bcryptjs
</code></pre></div>
<h2 id="configurando-las-opciones-de-jwt">Configurando las opciones de JWT</h2>
<p>En nuestro fichero .env podemos guardar las opciones de JWT, como el secreto, el tiempo de expiración, etc. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="nv">JWT_SECRET</span><span class="o">=</span>secret
<span class="nv">JWT_EXPIRATION_TIME</span><span class="o">=</span><span class="m">3600</span>
</code></pre></div>
<h2 id="implementando-la-autenticacion-y-autorizacion">Implementando la autenticación y autorización</h2>
<h3 id="modulo-de-autenticacion">Módulo de autenticación</h3>
<p>Ahora vamos a crear un módulo de autenticación, que será el encargado de gestionar la autenticación de los usuarios. Para ello, vamos a crear un módulo llamado <code>auth</code> dentro de la carpeta <code>src</code> y dentro de él, vamos a crear un fichero llamado <code>auth.module.ts</code> con el siguiente contenido:</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Module</span><span class="p">({</span>
<span class="w">  </span><span class="nx">imports</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="c1">// Configuración edl servicio de JWT</span>
<span class="w">    </span><span class="nx">JwtModule</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
<span class="w">      </span><span class="c1">// Lo voy a poner en base64</span>
<span class="w">      </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">(</span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOKEN_SECRET</span><span class="w"> </span><span class="o">||</span>
<span class="w">          </span><span class="s1">'Me_Gustan_Los_Pepinos_De_Leganes_Porque_Son_Grandes_Y_Hermosos'</span><span class="p">,</span>
<span class="w">        </span><span class="s1">'utf-8'</span><span class="p">,</span>
<span class="w">      </span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">),</span>
<span class="w">      </span><span class="nx">signOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOKEN_EXPIRES</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3600</span><span class="p">,</span><span class="w"> </span><span class="c1">// Tiempo de expiracion</span>
<span class="w">        </span><span class="nx">algorithm</span><span class="o">:</span><span class="w"> </span><span class="s1">'HS512'</span><span class="p">,</span><span class="w"> </span><span class="c1">// Algoritmo de encriptacion</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="c1">// Importamos el módulo de passport con las estrategias</span>
<span class="w">    </span><span class="nx">PassportModule</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span><span class="w"> </span><span class="nx">defaultStrategy</span><span class="o">:</span><span class="w"> </span><span class="s1">'jwt'</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="c1">// Importamos el módulo de usuarios porque usaremos su servicio</span>
<span class="w">    </span><span class="nx">UsersModule</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">controllers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">AuthController</span><span class="p">],</span>
<span class="w">  </span><span class="nx">providers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">AuthService</span><span class="p">,</span><span class="w"> </span><span class="nx">AuthMapper</span><span class="p">,</span><span class="w"> </span><span class="nx">JwtAuthStrategy</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">AuthModule</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>Como vemos, estamos importando el módulo de JWT y configurándolo con las opciones que hemos definido en el fichero .env. También estamos importando el módulo de passport y el módulo de usuarios, ya que usaremos su servicio.</p>
<h3 id="estrategia-de-autenticacion-jwt">Estrategia de autenticación JWT</h3>
<p>Ahora vamos a crear un fichero llamado <code>jwt.strategy.ts</code> dentro de la carpeta <code>src/auth</code>. En él, vamos a crear una clase llamada <code>JwtAuthStrategy</code> que extenderá de <code>PassportStrategy</code> y que implementará la estrategia de autenticación JWT. Esta clase tendrá un constructor que recibirá el servicio de autenticación y en el método <code>validate</code> validaremos el token y devolveremos el usuario. Las estrategias de Passport deben implementar el método <code>validate</code> que recibe el payload del token y devuelve el usuario.</p>
<p>El código de esta clase será el siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Injectable</span><span class="p">()</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">JwtAuthStrategy</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PassportStrategy</span><span class="p">(</span><span class="nx">Strategy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">authService</span><span class="o">:</span><span class="w"> </span><span class="kt">AuthService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jwtFromRequest</span><span class="o">:</span><span class="w"> </span><span class="kt">ExtractJwt.fromAuthHeaderAsBearerToken</span><span class="p">(),</span><span class="w"> </span><span class="c1">// el token como barer token</span>
<span class="w">      </span><span class="nx">ignoreExpiration</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// ignora la expiracion</span>
<span class="w">      </span><span class="c1">// La clave secreta</span>
<span class="w">      </span><span class="nx">secretOrKey</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">(</span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOKEN_SECRET</span><span class="w"> </span><span class="o">||</span>
<span class="w">          </span><span class="s1">'Me_Gustan_Los_Pepinos_De_Leganes_Porque_Son_Grandes_Y_Hermosos'</span><span class="p">,</span>
<span class="w">        </span><span class="s1">'utf-8'</span><span class="p">,</span>
<span class="w">      </span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">),</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Si se valida obtenemos el role</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">validate</span><span class="p">(</span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">Usuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">payload</span><span class="p">.</span><span class="nx">id</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="guardas-de-autorizacion-y-autenticacion">Guardas de autorización y autenticación</h3>
<p>El siguiente paso es crear las guardas de autorización y autenticación. La primera de ellas será la guarda de autenticación, que será la encargada de comprobar que el usuario está autenticado. Para ello, vamos a crear un fichero llamado <code>jwt-auth.guard.ts</code> dentro de la carpeta <code>src/auth</code> con el siguiente contenido. Esta extiende de <code>AuthGuard</code>  de Passport y recibe como parámetro la estrategia de autenticación JWT que hemos creado anteriormente.</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Injectable</span><span class="p">()</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">JwtAuthGuard</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AuthGuard</span><span class="p">(</span><span class="s1">'jwt'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">canActivate</span><span class="p">(</span>
<span class="w">    </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">ExecutionContext</span><span class="p">,</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Observable</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">super</span><span class="p">.</span><span class="nx">canActivate</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Nuestro siguiente paso es crear la guarda de autorización, que será la encargada de comprobar que el usuario tiene los roles necesarios para acceder a la ruta. Para ello, vamos a crear un fichero llamado <code>roles-auth.guard.ts</code> dentro de la carpeta <code>src/auth</code> con el siguiente contenido. <code>RolesAuthGuard</code> es un guardián personalizado que implementa la interfaz <code>CanActivate</code> de NestJS. El constructor de <code>RolesAuthGuard</code> inyecta una instancia de <code>Reflector</code>, que es una utilidad proporcionada por NestJS para recuperar metadatos.</p>
<p>La función canActivate es el corazón del guardián. Se llama cada vez que una solicitud entra en una ruta que está protegida por este guardián.</p>
<p>Dentro de canActivate, primero usamos Reflector para obtener los roles requeridos del manejador de ruta. Estos roles son metadatos que se agregaron al manejador de ruta utilizando el decorador <code>@Roles</code>.</p>
<p>Si no se requieren roles para la ruta, permitimos que la solicitud pase.</p>
<p>Luego, obtenemos el objeto de usuario de la solicitud. Este objeto de usuario debe haber sido adjuntado a la solicitud por un middleware o guardián anterior, como <code>JwtAuthGuard</code>. Comprobamos si el usuario tiene alguno de los roles requeridos. Si es así, permitimos que la solicitud pase. Si no, la solicitud es denegada.</p>
<div class="highlight"><pre><span></span><code><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RolesAuthGuard</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">CanActivate</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Logger</span><span class="p">(</span><span class="nx">RolesAuthGuard</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="nx">reflector</span><span class="o">:</span><span class="w"> </span><span class="kt">Reflector</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="nx">canActivate</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">ExecutionContext</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reflector</span><span class="p">.</span><span class="nx">get</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">'roles'</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">())</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Roles: </span><span class="si">${</span><span class="nx">roles</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">roles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">switchToHttp</span><span class="p">().</span><span class="nx">getRequest</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">user</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`User roles: </span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">roles</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// Al menos tenga un rol de los requeridos!!</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">role</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">roles</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">role</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">roles</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">hasRole</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">SetMetadata es una función proporcionada por NestJS que te permite agregar metadatos personalizados</span>
<span class="cm">a los manejadores de ruta. Estamos creando una nueva función, Roles, que toma una lista de roles</span>
<span class="cm">y utiliza SetMetadata para agregarlos como metadatos al manejador de ruta.</span>
<span class="cm">Podrás poner los roles requeridos en la ruta usando el decorador @Roles.</span>
<span class="cm"> */</span>
<span class="c1">// El decorador</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">Roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">...roles</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">SetMetadata</span><span class="p">(</span><span class="s1">'roles'</span><span class="p">,</span><span class="w"> </span><span class="nx">roles</span><span class="p">)</span>
</code></pre></div>
<h3 id="implementando-el-servicio-de-autenticacion">Implementando el servicio de autenticación</h3>
<p>En nuestro servicio haremos uso de los servicios de usuarios y de JWT. Para ello, vamos a crear un fichero llamado <code>auth.service.ts</code> dentro de la carpeta <code>src/auth</code> con el siguiente contenido. En él, haremos uso de Bcrypt para encriptar las contraseñas y comparar las contraseñas encriptadas con las que nos llegan en las peticiones (todo desde otro servicio en el módulo de usuarios). También haremos uso del servicio de usuarios para crear usuarios y buscarlos por nombre de usuario. Y generaremos los tokens JWT.</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Injectable</span><span class="p">()</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">AuthService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Logger</span><span class="p">(</span><span class="nx">AuthService</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">usersService</span><span class="o">:</span><span class="w"> </span><span class="kt">UsersService</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">authMapper</span><span class="o">:</span><span class="w"> </span><span class="kt">AuthMapper</span><span class="p">,</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">jwtService</span><span class="o">:</span><span class="w"> </span><span class="kt">JwtService</span><span class="p">,</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">singUp</span><span class="p">(</span><span class="nx">userSignUpDto</span><span class="o">:</span><span class="w"> </span><span class="kt">UserSignUpDto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`singUp </span><span class="si">${</span><span class="nx">userSignUpDto</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">usersService</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">authMapper</span><span class="p">.</span><span class="nx">toCreateDto</span><span class="p">(</span><span class="nx">userSignUpDto</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">singIn</span><span class="p">(</span><span class="nx">userSignInDto</span><span class="o">:</span><span class="w"> </span><span class="kt">UserSignInDto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`singIn </span><span class="si">${</span><span class="nx">userSignInDto</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">usersService</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">userSignInDto</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BadRequestException</span><span class="p">(</span><span class="s1">'username or password are invalid'</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isValidPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">usersService</span><span class="p">.</span><span class="nx">validatePassword</span><span class="p">(</span>
<span class="w">      </span><span class="nx">userSignInDto</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="c1">// plain</span>
<span class="w">      </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="c1">// hash</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isValidPassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BadRequestException</span><span class="p">(</span><span class="s1">'username or password are invalid'</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`validateUser </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">usersService</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">getAccessToken</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`getAccessToken </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">userId</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="c1">//console.log(payload)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">access_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">jwtService</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">access_token</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">InternalServerErrorException</span><span class="p">(</span><span class="s1">'Error al generar el token'</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="protegiendo-las-rutas">Protegiendo las rutas</h2>
<p>Para proteger las rutas haremos uso de nuestros guards: <code>JwtAuthGuard</code>, <code>RolesAuthGuard</code>. Podemos proteger toda la ruta o solo los métodos que queramos. Por ejemplo, en el siguiente código, protegemos toda la ruta <code>/categorias</code> con el guard de autenticación y solo el método <code>create</code> con el guard de autorización admin, el resto es para usuarios.</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Controller</span><span class="p">(</span><span class="s1">'categorias'</span><span class="p">)</span>
<span class="kd">@UseInterceptors</span><span class="p">(</span><span class="nx">CacheInterceptor</span><span class="p">)</span><span class="w"> </span><span class="c1">// Aplicar el interceptor aquí de cahce</span>
<span class="kd">@UseGuards</span><span class="p">(</span><span class="nx">JwtAuthGuard</span><span class="p">,</span><span class="w"> </span><span class="nx">RolesAuthGuard</span><span class="p">)</span><span class="w"> </span><span class="c1">// Aplicar el guard aquí para autenticados con JWT y Roles (lo aplico a nivel de controlador)</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CategoriasController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Logger</span><span class="p">(</span><span class="nx">CategoriasController</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">categoriasService</span><span class="o">:</span><span class="w"> </span><span class="kt">CategoriasService</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">@Get</span><span class="p">()</span>
<span class="w">  </span><span class="kd">@CacheKey</span><span class="p">(</span><span class="s1">'all_categories'</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@CacheTTL</span><span class="p">(</span><span class="mf">30</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@Roles</span><span class="p">(</span><span class="s1">'USER'</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findAll</span><span class="p">(</span><span class="kd">@Paginate</span><span class="p">()</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">PaginateQuery</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Find all categorias'</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">categoriasService</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">@Get</span><span class="p">(</span><span class="s1">':id'</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@Roles</span><span class="p">(</span><span class="s1">'USER'</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findOne</span><span class="p">(</span><span class="kd">@Param</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="w"> </span><span class="nx">ParseUUIDPipe</span><span class="p">)</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Find one categoria by id:</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">categoriasService</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">@Post</span><span class="p">()</span>
<span class="w">  </span><span class="kd">@HttpCode</span><span class="p">(</span><span class="mf">201</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@Roles</span><span class="p">(</span><span class="s1">'ADMIN'</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="kd">@Body</span><span class="p">()</span><span class="w"> </span><span class="nx">createCategoriaDto</span><span class="o">:</span><span class="w"> </span><span class="kt">CreateCategoriaDto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Create categoria </span><span class="si">${</span><span class="nx">createCategoriaDto</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">categoriasService</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">createCategoriaDto</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Otro ejemplo, en el siguiente código,la ruta está abierta pero el método <code>create</code> solo lo pueden usar los usuarios autenticados con JWT y con rol de admin.</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Controller</span><span class="p">(</span><span class="s1">'productos'</span><span class="p">)</span>
<span class="kd">@UseInterceptors</span><span class="p">(</span><span class="nx">CacheInterceptor</span><span class="p">)</span><span class="w"> </span><span class="c1">// Aplicar el interceptor aquí de cahce</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ProductosController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">logger</span><span class="o">:</span><span class="w"> </span><span class="kt">Logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Logger</span><span class="p">(</span><span class="nx">ProductosController</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">productosService</span><span class="o">:</span><span class="w"> </span><span class="kt">ProductosService</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">@Get</span><span class="p">()</span>
<span class="w">  </span><span class="kd">@CacheKey</span><span class="p">(</span><span class="s1">'all_products'</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@CacheTTL</span><span class="p">(</span><span class="mf">30</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findAll</span><span class="p">(</span><span class="kd">@Paginate</span><span class="p">()</span><span class="w"> </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">PaginateQuery</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Find all productos'</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">productosService</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">@Get</span><span class="p">(</span><span class="s1">':id'</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findOne</span><span class="p">(</span><span class="kd">@Param</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Find one producto by id:</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">productosService</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">@Post</span><span class="p">()</span>
<span class="w">  </span><span class="kd">@HttpCode</span><span class="p">(</span><span class="mf">201</span><span class="p">)</span>
<span class="w">  </span><span class="kd">@UseGuards</span><span class="p">(</span><span class="nx">JwtAuthGuard</span><span class="p">,</span><span class="w"> </span><span class="nx">RolesAuthGuard</span><span class="p">)</span><span class="w"> </span><span class="c1">// Aplicar el guard aquí</span>
<span class="w">  </span><span class="kd">@Roles</span><span class="p">(</span><span class="s1">'ADMIN'</span><span class="p">)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="kd">@Body</span><span class="p">()</span><span class="w"> </span><span class="nx">createProductoDto</span><span class="o">:</span><span class="w"> </span><span class="kt">CreateProductoDto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Create producto </span><span class="si">${</span><span class="nx">createProductoDto</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">productosService</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">createProductoDto</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="ssl-y-https">SSL y HTTPS</h1>
<p>Para usar SSL y HTTPS en NestJS, lo primero que tenemos que hacer es generar un certificado autofirmado. Esta vez vamos a usar OpenSSL para generar el certificado. Para ello, vamos a ejecutar el siguiente comando:</p>
<div class="highlight"><pre><span></span><code><span class="sb">```</span>bash
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>keystore.p12<span class="w"> </span><span class="m">2048</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-key<span class="w"> </span>keystore.p12<span class="w"> </span>-out<span class="w"> </span>cert.pem<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span>
</code></pre></div>
<p>Posteriormente añadiremos el certificado a nuestro proyecto. Para ello, vamos a crear una carpeta llamada <code>cert</code> y copiamos los ficheros <code>keystore.p12</code> y <code>cert.pem</code> en ella.</p>
<p>Desde el fichero .env, vamos a añadir las siguientes variables de entorno:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SSL_KEY</span><span class="o">=</span>./cert/keystore.p12
<span class="nv">SSL_CERT</span><span class="o">=</span>./cert/cert.pem
</code></pre></div>
<p>Finalmente, vamos a modificar el fichero <code>main.ts</code> para que use el certificado. Para ello, vamos a añadir el siguiente código:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">bootstrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Leemos la configuración de los certificados SSL</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">httpsOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SSL_KEY</span><span class="p">)),</span>
<span class="w">    </span><span class="nx">cert</span><span class="o">:</span><span class="w"> </span><span class="kt">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SSL_CERT</span><span class="p">)),</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">NestFactory</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">AppModule</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">httpsOptions</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="c1">// Configuración de la versión de la API</span>
<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">setGlobalPrefix</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">'v1'</span><span class="p">)</span>
<span class="w">  </span><span class="c1">// Activamos las validaciones body y dtos</span>
<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">useGlobalPipes</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ValidationPipe</span><span class="p">())</span>
<span class="w">  </span><span class="c1">// Configuración del puerto de escucha</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Inicialización de la aplicación y cuando esté lista se muestra un mensaje en consola</span>
<span class="nx">bootstrap</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
<span class="w">    </span><span class="sb">`🟢 Servidor escuchando en puerto: </span><span class="si">${</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span>
<span class="w">    </span><span class="si">}</span><span class="sb"> y perfil: </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="si">}</span><span class="sb"> 🚀`</span><span class="p">,</span>
<span class="w">  </span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="testeando-la-seguridad">Testeando la seguridad</h2>
<p>A nivel unitario, nuestro servicios y controladores no se ven modificados por la seguridad. Por lo que no tenemos que hacer nada especial para testearlos.</p>
<p>Pero a nivel de integración con SuperTest, si que tenemos que hacer algunas modificaciones. Son sutil,es pero le vamos a decir que no aplique los guardas en los test ya generados
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">mockCategoriasService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">findAll</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">findOne</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">update</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">remove</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">removeSoft</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}</span>

<span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Cargamos solo el controlador y el servicio que vamos a probar, no el módulo que arrastra con todo</span>
<span class="w">    </span><span class="c1">// No es de integración si no e2e, con mocks</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="kr">module</span><span class="nx">Fixture</span><span class="o">:</span><span class="w"> </span><span class="nx">TestingModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Test</span><span class="p">.</span><span class="nx">createTestingModule</span><span class="p">({</span>
<span class="w">      </span><span class="nx">imports</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">CacheModule</span><span class="p">.</span><span class="nx">register</span><span class="p">()],</span><span class="w"> </span><span class="c1">// importamos el módulo de caché, lo necesita el controlador (interceptores y anotaciones)</span>
<span class="w">      </span><span class="nx">controllers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">CategoriasController</span><span class="p">],</span>
<span class="w">      </span><span class="nx">providers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="nx">CategoriasService</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">provide</span><span class="o">:</span><span class="w"> </span><span class="kt">CategoriasService</span><span class="p">,</span><span class="w"> </span><span class="nx">useValue</span><span class="o">:</span><span class="w"> </span><span class="kt">mockCategoriasService</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Mockeamos el servicio</span>
<span class="w">        </span><span class="c1">// Tambien podemos mockear los guardas aquí</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        {</span>
<span class="cm">          provide: JwtAuthGuard,</span>
<span class="cm">          useValue: { canActivate: () =&gt; true },</span>
<span class="cm">        },</span>
<span class="cm">        {</span>
<span class="cm">          provide: RolesAuthGuard,</span>
<span class="cm">          useValue: { canActivate: () =&gt; true },</span>
<span class="cm">        },</span>
<span class="cm">        */</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">overrideGuard</span><span class="p">(</span><span class="nx">JwtAuthGuard</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">useValue</span><span class="p">({</span><span class="w"> </span><span class="nx">canActivate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="c1">// Esto permite que todas las solicitudes pasen el JwtAuthGuard</span>
<span class="w">      </span><span class="p">.</span><span class="nx">overrideGuard</span><span class="p">(</span><span class="nx">RolesAuthGuard</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">useValue</span><span class="p">({</span><span class="w"> </span><span class="nx">canActivate</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="c1">// Esto permite que todas las solicitudes pasen el RolesAuthGuard</span>
<span class="w">      </span><span class="p">.</span><span class="nx">compile</span><span class="p">()</span>

<span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">module</span><span class="nx">Fixture.createNestApplication</span><span class="p">()</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">afterAll</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="w">  </span><span class="p">})</span>
</code></pre></div></p>
<h1 id="practica-de-clase-seguridad">Práctica de clase: Seguridad</h1>
<ol>
<li>Crea todo el modelo de seguridad para que un usuario pueda registrarse y loguearse en el sistema.</li>
<li>Los funkos solo pueden ser creados, modificados y eliminados por un usuario administrador. Pueden verse por todo el mundo.</li>
<li>Las categorías solo pueden ser creadas, modificadas y eliminadas por un usuario administrador.</li>
<li>Los pedidos solo pueden ser creados, modificados y eliminados por un usuario administrador.</li>
<li>Un usuario puede ver y modificar su perfil y sus pedidos.</li>
</ol>
<h1 id="proyecto">Proyecto</h1>
<p>Puedes consultar esta parte en <a href="https://github.com/joseluisgs/DesarrolloWebEntornosServidor-03-Proyecto-2023-2024/releases/tag/autenticaci%C3%B3n_autorizaci%C3%B3n">el proyecto de ejemplo</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>