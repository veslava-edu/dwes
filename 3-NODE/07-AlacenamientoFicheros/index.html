
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://veslava-edu.github.io/dwes/3-NODE/07-AlacenamientoFicheros/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>07 AlacenamientoFicheros - DWES</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script><script src="../../toggle-sidebar.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#almacenamiento-de-ficheros" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DWES" class="md-header__button md-logo" aria-label="DWES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DWES
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              07 AlacenamientoFicheros
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Cambiar a modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Inicio

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../1-ArquitecturaWEB/UD1-Arquitectura-Web-y-Software-en-Servidor/" class="md-tabs__link">
          
  
  
  Arquitectura WEB y Servidor

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../2-PHP/01-Introduccion/" class="md-tabs__link">
          
  
  
  PHP

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="#" class="md-tabs__link">
          
  
  
  Node.js

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DWES" class="md-nav__button md-logo" aria-label="DWES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DWES
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inicio
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Arquitectura WEB y Servidor
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Arquitectura WEB y Servidor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1-Arquitectura-Web-y-Software-en-Servidor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    00 - Arquitectura-Web-y-Software-en-Servidor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.1-Entorno-WAMP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Entorno-WAMP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.2-Virtualizacion-Docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Virtualizacion-Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-ArquitecturaWEB/UD1.3-Control-Versiones-GIT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Control-Versiones-GIT
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PHP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            PHP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/01-Introduccion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Introducción
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/02-Sintaxis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Sintaxis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/03-Control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Estructuras de Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/04-Arrays-Funciones-Strings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 - Arrays, Funciones y Strings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/05-POO/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    05 - POO - Programación Orientada a Objetos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/06-Include/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    06 - Include y Require
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/07-GET-POST-Formularios/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 - GET y POST - Formularios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/08-Gesti%C3%B3n-de-estado-Cookies-Sesiones/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    08 - Gestión de estado - Cookies y Sesiones
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/09-Ficheros/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    09 - Ficheros
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/10-BasesDatos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 - Bases de Datos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/11-Navegacion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11 - Navegación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/12-Dependencias/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12 - Dependencias
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/13-Servicios-WEB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13 - Servicios WEB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/14-Documentacion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14 - Documentación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/15-LOGS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    15 - Logs en PHP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/16-WebScraping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    16 - WebScraping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-PHP/17-Testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    17 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_18" >
        
          
          <label class="md-nav__link" for="__nav_3_18" id="__nav_3_18_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Laravel
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_18">
            <span class="md-nav__icon md-icon"></span>
            Laravel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L1 - Introducción a Laravel
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L2 - Entorno
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L3 - Eloquent ORM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 - Controladores
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L5 - Almacenamiento
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L6 - Vistas (Blade)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L7 - Autenticación y Autorización
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L8 - Sesiones y Cookies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L9 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Node.js
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Node.js
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 - Intro a Node.js
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 - Intro a TypeScript
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 - Intro a NestJS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 - Creación de Recursos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    05 - TypeORM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    06 - Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 - Almacenamiento de Ficheros
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    08 - WebSockets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    09 - Endpoints Avanzados
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 - MongoDB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11 - Seguridad
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12 - Documentación
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    13 - Perfiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="#" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    14 - Despliegue
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#subiendo-ficheros" class="md-nav__link">
    <span class="md-ellipsis">
      Subiendo ficheros
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#personalizando-fileinterceptor" class="md-nav__link">
    <span class="md-ellipsis">
      Personalizando FileInterceptor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inicializando-el-sistema-de-almacenamiento" class="md-nav__link">
    <span class="md-ellipsis">
      Inicializando el Sistema de almacenamiento
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#devolviendo-una-fichero-subido" class="md-nav__link">
    <span class="md-ellipsis">
      Devolviendo una fichero subido
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uso-de-guards-para-comprobar-que-el-id-existe-antes-de-almacenar-el-fichero" class="md-nav__link">
    <span class="md-ellipsis">
      Uso de Guards para comprobar que el id existe antes de almacenar el fichero
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<ul>
<li><a href="#almacenamiento-de-ficheros">Almacenamiento de Ficheros</a></li>
<li><a href="#subiendo-ficheros">Subiendo ficheros</a></li>
<li><a href="#personalizando-fileinterceptor">Personalizando FileInterceptor</a></li>
<li><a href="#inicializando-el-sistema-de-almacenamiento">Inicializando el Sistema de almacenamiento</a></li>
<li><a href="#devolviendo-una-fichero-subido">Devolviendo una fichero subido</a></li>
<li><a href="#uso-de-guards-para-comprobar-que-el-id-existe-antes-de-almacenar-el-fichero">Uso de Guards para comprobar que el id existe antes de almacenar el fichero</a></li>
<li><a href="#testeando-el-sistema-de-almacenamiento">Testeando el sistema de almacenamiento</a></li>
<li><a href="#servicios">Servicios</a></li>
<li><a href="#testeando-el-controlador">Testeando el controlador</a></li>
<li><a href="#testeando-e2e">Testeando e2e</a></li>
<li><a href="#práctica-de-clase-almacenamiento-de-ficheros">Práctica de clase: Almacenamiento de Ficheros</a></li>
<li><a href="#proyecto">Proyecto</a></li>
</ul>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../images/07-banner.jpg"><img alt="" src="../images/07-banner.jpg"/></a></p>
<h1 id="almacenamiento-de-ficheros">Almacenamiento de Ficheros</h1>
<p>Para almacenar ficheros, <a href="https://docs.nestjs.com/techniques/file-upload">Nestjs nos ofrece total transparencia con Multer</a>.</p>
<p>Lo primero que debemos hacer es instalar los tipos de Multer
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>--save<span class="w"> </span>@types/multer
</code></pre></div></p>
<h2 id="subiendo-ficheros">Subiendo ficheros</h2>
<p>A partir de aquí podemos usar los <a href="https://docs.nestjs.com/interceptors">Interceptadores</a>. En NestJS, un interceptor es una clase que se utiliza para interceptar y modificar el flujo de ejecución de una solicitud entrante antes de que llegue al controlador correspondiente o después de que se haya completado la respuesta. Los interceptores se pueden utilizar para realizar tareas comunes de manera centralizada, como la transformación de datos, la validación, el registro, la autorización, el manejo de errores, entre otros.</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="../images/Interceptors_1.png"><img alt="" src="../images/Interceptors_1.png"/></a></p>
<p><code>FileInterceptor</code> y <code>@UploadedFile</code> son funcionalidades proporcionadas por el módulo <code>@nestjs/platform-express</code> para facilitar la carga de archivos en NestJS.</p>
<p><code>FileInterceptor</code> es un interceptor predefinido que se utiliza para interceptar y procesar la carga de archivos en una ruta específica. Se utiliza para manejar la lógica relacionada con la carga de archivos, como almacenar los archivos en un directorio, generar nombres de archivo únicos, validar el tipo de archivo, entre otras tareas.</p>
<p>En el ejemplo que proporcionaste:</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Post</span><span class="p">(</span><span class="s1">'upload'</span><span class="p">)</span>
<span class="kd">@UseInterceptors</span><span class="p">(</span><span class="nx">FileInterceptor</span><span class="p">(</span><span class="s1">'file'</span><span class="p">))</span>
<span class="nx">uploadFile</span><span class="p">(</span><span class="kd">@UploadedFile</span><span class="p">()</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">Express.Multer.File</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p><code>@Post('upload')</code> define una ruta <code>POST</code> en la cual se realizará la carga de archivos. La ruta será <code>/upload</code> en este caso.</p>
</li>
<li>
<p><code>@UseInterceptors(FileInterceptor('file'))</code> aplica el interceptor <code>FileInterceptor</code> a la ruta <code>POST</code> para manejar la carga de archivos. El parámetro <code>'file'</code> especifica el nombre del campo en el formulario de carga de archivos.</p>
</li>
<li>
<p><code>@UploadedFile()</code> es un decorador utilizado en el controlador para obtener el archivo cargado. En este caso, se declara el parámetro <code>file</code> de tipo <code>Express.Multer.File</code> para recibir el archivo cargado. Puedes acceder a diferentes propiedades del archivo, como <code>file.filename</code>, <code>file.originalname</code>, <code>file.mimetype</code>, etc.</p>
</li>
</ul>
<p>Dentro del método <code>uploadFile</code>, se realiza un simple <code>console.log(file)</code> para imprimir la información del archivo cargado.</p>
<p>En resumen, <code>FileInterceptor</code> y <code>@UploadedFile</code> son funcionalidades de NestJS que simplifican el manejo de la carga de archivos en una ruta específica. <code>FileInterceptor</code> se encarga de procesar la carga de archivos, mientras que <code>@UploadedFile</code> se utiliza para obtener el archivo cargado en el controlador.</p>
<h2 id="personalizando-fileinterceptor">Personalizando FileInterceptor</h2>
<p>Para personalizar el comportamiento de <code>FileInterceptor</code>, puedes pasar un objeto de opciones como segundo parámetro al llamarlo. Aquí tienes algunas opciones comunes que puedes utilizar:</p>
<ul>
<li>
<p><code>storage</code>: Define el almacenamiento para los archivos subidos. Puedes utilizar el método <code>diskStorage</code> del módulo <code>multer</code> para especificar la carpeta de destino y el nombre del archivo.</p>
</li>
<li>
<p><code>fileFilter</code>: Permite filtrar los archivos que se aceptan o rechazan en función de su tipo o cualquier otra condición personalizada. Puedes proporcionar una función que reciba la solicitud (<code>req</code>), el archivo (<code>file</code>) y un callback (<code>cb</code>). El callback debe llamarse con un error si el archivo no cumple con los criterios de filtrado, o con <code>null</code> y un valor booleano (<code>true</code> o <code>false</code>) para indicar si el archivo es aceptado o no.</p>
</li>
<li>
<p><code>limits</code>: Permite establecer límites en el tamaño del archivo y el número máximo de archivos permitidos. Puedes especificar el tamaño máximo del archivo en bytes utilizando la propiedad <code>fileSize</code> y el número máximo de archivos utilizando la propiedad <code>files</code>.</p>
</li>
<li>
<p><code>preservePath</code>: Permite conservar la estructura de directorios original del archivo subido en lugar de aplanarla. Esto es útil si deseas mantener la estructura de carpetas del cliente al guardar los archivos.</p>
</li>
</ul>
<p>Aquí tienes un ejemplo de cómo personalizar <code>FileInterceptor</code> con algunas de estas opciones:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileInterceptor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@nestjs/platform-express'</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">diskStorage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'multer'</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="kd">@UseInterceptors</span><span class="p">(</span>
<span class="w">  </span><span class="nx">FileInterceptor</span><span class="p">(</span><span class="s1">'file'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">storage</span><span class="o">:</span><span class="w"> </span><span class="kt">diskStorage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s1">'./uploads'</span><span class="p">,</span>
<span class="w">      </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateUniqueName</span><span class="p">();</span><span class="w"> </span><span class="c1">// Lógica para generar un nombre único</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getFileExtension</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">uniqueName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">fileExtension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">);</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">fileFilter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isValidFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'Invalid file type'</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">limits</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1 MB</span>
<span class="w">      </span><span class="nx">files</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// Permitir solo un archivo</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">preservePath</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">}),</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="inicializando-el-sistema-de-almacenamiento">Inicializando el Sistema de almacenamiento</h2>
<p>Si queremos inicializar el sistema de almacenamiento, podemos hacerlo haciendo uso de <code>onModuleInit()</code>. Este método se ejecutará cuando se cargue el módulo correspondiente.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Este método se ejecuta cuando el módulo se inicia</span>
<span class="w">  </span><span class="c1">// En este caso, si estamos en entorno de desarrollo, se eliminan los archivos</span>
<span class="w">  </span><span class="c1">// del directorio de uploads y se crea de nuevo.</span>
<span class="w">  </span><span class="c1">// Esto es para que cada vez que se inicie el servidor, el directorio esté vacío.</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">onModuleInit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isDev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Eliminando ficheros de </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">        </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">))</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`Creando directorio de subida de archivos en </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uploadsDir</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h2 id="devolviendo-una-fichero-subido">Devolviendo una fichero subido</h2>
<p>Para devolver una fichero subido, podemos hacerlo de la siguiente manera usando <code>Response</code>de Express:</p>
<p><div class="highlight"><pre><span></span><code><span class="w"> </span><span class="kd">@Get</span><span class="p">(</span><span class="s1">':filename'</span><span class="p">)</span>
<span class="w">  </span><span class="nx">getFile</span><span class="p">(</span><span class="kd">@Param</span><span class="p">(</span><span class="s1">'filename'</span><span class="p">)</span><span class="w"> </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kd">@Res</span><span class="p">()</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">join</span><span class="p">(</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span><span class="w"> </span><span class="c1">// process.cwd() devuelve el directorio de trabajo actual</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">UPLOADS_DIR</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">'./storage-dir'</span><span class="p">,</span><span class="w"> </span><span class="c1">// directorio de subida de archivos</span>
<span class="w">      </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="c1">// nombre del archivo</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Comprobamos si existe el fichero</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Fichero encontrado </span><span class="si">${</span><span class="nx">file</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NotFoundException</span><span class="p">(</span><span class="sb">`El fichero </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb"> no existe.`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
Te recomiendo que te lleves toda la lógica al Servicio y no al controlador.</p>
<h2 id="uso-de-guards-para-comprobar-que-el-id-existe-antes-de-almacenar-el-fichero">Uso de Guards para comprobar que el id existe antes de almacenar el fichero</h2>
<p>Al usar el sistema de Nestjs, el fichero se almacena antes de ejecutar la lógica del servicio. Esto quiere decir que si queremos asignar una imagen a un producto y este no existe, almacenamos la imagen y luego lanzamos la excepción.</p>
<p>Es por ello que es recomendable usar un <a href="https://docs.nestjs.com/guards">guard</a> para comprobar que el id existe antes de almacenar el fichero. Para ello podemos usar el siguiente guard, que se le pasa el servicio de productos</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Injectable</span><span class="p">()</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ProductoExistsGuard</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">CanActivate</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">productosService</span><span class="o">:</span><span class="w"> </span><span class="kt">ProductosService</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">canActivate</span><span class="p">(</span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">ExecutionContext</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">switchToHttp</span><span class="p">().</span><span class="nx">getRequest</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">producto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">productosService</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">producto</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NotFoundException</span><span class="p">(</span><span class="sb">`El producto con id </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> no existe`</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ahora en nuestro Controlador en el metodo patch, podemos usarlo</p>
<div class="highlight"><pre><span></span><code><span class="kd">@Patch</span><span class="p">(</span><span class="s1">'imagen/:id'</span><span class="p">)</span>
<span class="kd">@UseGuards</span><span class="p">(</span><span class="nx">ProductoExistsGuard</span><span class="p">)</span>
<span class="kd">@UseInterceptors</span><span class="p">(</span>
<span class="w">  </span><span class="nx">FileInterceptor</span><span class="p">(</span><span class="s1">'file'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">storage</span><span class="o">:</span><span class="w"> </span><span class="kt">diskStorage</span><span class="p">({</span>
<span class="w">      </span><span class="nx">destination</span><span class="o">:</span><span class="w"> </span><span class="s1">'./uploads'</span><span class="p">,</span>
<span class="w">      </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateUniqueName</span><span class="p">()</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getFileExtension</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="p">)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">uniqueName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">fileExtension</span><span class="si">}</span><span class="sb">`</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">)</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">fileFilter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isValidFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">cb</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'Invalid file type'</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">limits</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1 MB</span>
<span class="w">      </span><span class="nx">files</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// Permitir solo un archivo</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">preservePath</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">}),</span>
<span class="p">)</span>
<span class="k">async</span><span class="w"> </span><span class="nx">updateImage</span><span class="p">(</span>
<span class="w">  </span><span class="kd">@Param</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">  </span><span class="kd">@UploadedFile</span><span class="p">()</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">Express.Multer.File</span><span class="p">,</span>
<span class="w">  </span><span class="kd">@Req</span><span class="p">()</span><span class="w"> </span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ResponseProductoDto</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">producto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">productosService</span><span class="p">.</span><span class="nx">updateImage</span><span class="p">(</span>
<span class="w">    </span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">file</span><span class="p">,</span>
<span class="w">    </span><span class="nx">req</span><span class="p">,</span>
<span class="w">    </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mapper</span><span class="p">.</span><span class="nx">toResponseDto</span><span class="p">(</span><span class="nx">producto</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="testeando-el-sistema-de-almacenamiento">Testeando el sistema de almacenamiento</h1>
<h2 id="servicios">Servicios</h2>
<p>Para testear unitariamente el servicio, puedes mockear los elementos que consideres. Por ejemplo si estoy testeando un servicio de productos que usa el servicio de almacenamiento puedo crear un mock del mismo.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">storageServiceMock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">removeFile</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getFileNameWithouUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">jest.fn</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>Y luego 
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'updateImage'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should update a producto image'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">protocol</span><span class="o">:</span><span class="w"> </span><span class="s1">'http'</span><span class="p">,</span>
<span class="w">        </span><span class="nx">get</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">'localhost'</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="s1">'new_image'</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockProductoEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ProductoEntity</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockResponseProductoDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ResponseProductoDto</span><span class="p">()</span>

<span class="w">      </span><span class="nx">jest</span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="s1">'exists'</span><span class="p">).</span><span class="nx">mockResolvedValue</span><span class="p">(</span><span class="nx">mockProductoEntity</span><span class="p">)</span>

<span class="w">      </span><span class="nx">jest</span>
<span class="w">        </span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nx">productoRepository</span><span class="p">,</span><span class="w"> </span><span class="s1">'save'</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">mockResolvedValue</span><span class="p">(</span><span class="nx">mockProductoEntity</span><span class="p">)</span>

<span class="w">      </span><span class="nx">jest</span>
<span class="w">        </span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nx">mapper</span><span class="p">,</span><span class="w"> </span><span class="s1">'toResponseDto'</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">mockReturnValue</span><span class="p">(</span><span class="nx">mockResponseProductoDto</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">updateImage</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">mockFile</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">,</span><span class="w"> </span><span class="nx">mockRequest</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<span class="w">      </span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">mockResponseProductoDto</span><span class="p">)</span>

<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">storageService</span><span class="p">.</span><span class="nx">removeFile</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">storageService</span><span class="p">.</span><span class="nx">getFileNameWithouUrl</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
</code></pre></div></p>
<h2 id="testeando-el-controlador">Testeando el controlador</h2>
<p>En este caso mockeamos nuestro servicio, con el método nuevo
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="nx">describe</span><span class="p">(</span><span class="s1">'updateImage'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should update a producto image'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Express</span><span class="p">.</span><span class="nx">Multer</span><span class="p">.</span><span class="nx">File</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Request</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mockResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ResponseProductoDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ResponseProductoDto</span><span class="p">()</span>

<span class="w">      </span><span class="nx">jest</span><span class="p">.</span><span class="nx">spyOn</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="s1">'updateImage'</span><span class="p">).</span><span class="nx">mockResolvedValue</span><span class="p">(</span><span class="nx">mockResult</span><span class="p">)</span>

<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">updateImage</span><span class="p">(</span><span class="nx">mockId</span><span class="p">,</span><span class="w"> </span><span class="nx">mockFile</span><span class="p">,</span><span class="w"> </span><span class="nx">mockReq</span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">service</span><span class="p">.</span><span class="nx">updateImage</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span>
<span class="w">        </span><span class="nx">mockId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockFile</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockReq</span><span class="p">,</span>
<span class="w">        </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">mockResult</span><span class="p">).</span><span class="nx">toBeInstanceOf</span><span class="p">(</span><span class="nx">ResponseProductoDto</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w"> </span><span class="p">})</span>
</code></pre></div></p>
<h2 id="testeando-e2e">Testeando e2e</h2>
<p>Procedemos como siempre, mockemos el servicio con su nuevo método y hacemos la petición pasándole el fichero como petición multiparte,</p>
<p>```ts
 describe('PATCH /productos/imagen/:id', () =&gt; {
    it('should update the product image', async () =&gt; {
      const file = new Buffer('file')</p>
<pre><code>  mockProductosService.updateImage.mockResolvedValue(myProductoResponse)

  await request(app.getHttpServer())
    .patch(`${myEndpoint}/imagen/${myProductoResponse.id}`)
    .attach('file', file, 'image.jpg')
    .set('Content-Type', 'multipart/form-data')
    .expect(200)
})
</code></pre>
<p>})
 ```</p>
<h1 id="practica-de-clase-almacenamiento-de-ficheros">Práctica de clase: Almacenamiento de Ficheros</h1>
<ol>
<li>Crea el sistema de almacenamiento para subir imágenes a los Funkos.</li>
<li>Permite consultar y devolver la imagen de un Funko.</li>
<li>Testea los nuevos elementos tanto a nivel unitario como e2e.</li>
</ol>
<h1 id="proyecto">Proyecto</h1>
<p>Puedes consultar esta parte en <a href="https://github.com/joseluisgs/DesarrolloWebEntornosServidor-03-Proyecto-2023-2024/releases/tag/storage">el proyecto de ejemplo</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>